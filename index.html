<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truy·ªÅn File v·ªõi Ch·ªØ K√Ω S·ªë RSA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 5px;
        }

        .tab-button {
            padding: 15px 30px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 45px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 8px 20px rgba(255,107,107,0.3);
            transform: translateY(-2px);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        input[type="file"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
            background: white;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #fafbfc;
            resize: vertical;
            min-height: 150px;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102,126,234,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
            background: #f8f9ff;
        }

        .result.success {
            border-left-color: #2ed573;
            background: #f0fff4;
            color: #2d5a2d;
        }

        .result.error {
            border-left-color: #ff6b6b;
            background: #fff5f5;
            color: #c53030;
        }

        .key-display {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #2196f3;
        }

        .file-info h4 {
            margin-bottom: 10px;
            color: #1565c0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
                border-radius: 15px;
            }
            
            .tab-button {
                margin: 5px 0;
                border-radius: 10px;
            }
            
            .container {
                padding: 10px;
            }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #2ed573; }
        .status-error { background: #ff6b6b; }
        .status-warning { background: #ffa502; }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .share-option {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0,0,0,0.05);
        border-radius: 10px;
        display: none;
    }

        .share-option.active {
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .help-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .help-text a {
            color: #667eea;
            text-decoration: underline;
            transition: all 0.3s ease;
        }

        .help-text a:hover {
            color: #764ba2;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Truy·ªÅn File v·ªõi Ch·ªØ K√Ω S·ªë RSA</h1>
            <p>B·∫£o m·∫≠t v√† x√°c th·ª±c file v·ªõi c√¥ng ngh·ªá m√£ h√≥a RSA</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('generate')">üîë T·∫°o Kh√≥a</button>
            <button class="tab-button" onclick="showTab('sign')">‚úçÔ∏è K√Ω File</button>
            <button class="tab-button" onclick="showTab('verify')">‚úÖ X√°c Minh</button>
            <button class="tab-button" onclick="showTab('share')">üì§ Chia S·∫ª</button>
        </div>

        <!-- Tab T·∫°o Kh√≥a -->
        <div id="generate" class="tab-content active">
            <div class="card">
                <h2>üîë T·∫°o C·∫∑p Kh√≥a RSA</h2>
                <p>T·∫°o c·∫∑p kh√≥a c√¥ng khai v√† ri√™ng t∆∞ ƒë·ªÉ k√Ω v√† x√°c minh file</p>
                
                <div class="form-group">
                    <label>ƒê·ªô d√†i kh√≥a:</label>
                    <select id="keySize" style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px;">
                        <option value="1024">1024 bit (Nhanh)</option>
                        <option value="2048" selected>2048 bit (Khuy·∫øn ngh·ªã)</option>
                        <option value="4096">4096 bit (B·∫£o m·∫≠t cao)</option>
                    </select>
                </div>

                <button class="btn" onclick="generateKeys()">üîÑ T·∫°o Kh√≥a M·ªõi</button>
                
                <div id="keyResult"></div>
            </div>
        </div>

        <!-- Tab K√Ω File -->
        <div id="sign" class="tab-content">
            <div class="card">
                <h2>‚úçÔ∏è K√Ω File</h2>
                <p>T·∫£i file v√† t·∫°o ch·ªØ k√Ω s·ªë ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn</p>

                <div class="form-group">
                    <label>üìÅ Ch·ªçn file c·∫ßn k√Ω:</label>
                    <input type="file" id="fileToSign" onchange="handleFileSelect(this, 'sign')">
                </div>

                <div class="form-group">
                    <label>üîê Kh√≥a ri√™ng t∆∞ (Private Key):</label>
                    <textarea id="privateKey" placeholder="Nh·∫≠p kh√≥a ri√™ng t∆∞ c·ªßa b·∫°n..."></textarea>
                </div>

                <button class="btn" onclick="signFile()">‚úçÔ∏è K√Ω File</button>
                <button class="btn btn-success" onclick="downloadSignedPackage()" id="downloadBtn" style="display:none;">üì• T·∫£i Package ƒê√£ K√Ω</button>

                <div id="signResult"></div>
            </div>
        </div>

        <!-- Tab X√°c Minh -->
        <div id="verify" class="tab-content">
            <div class="card">
                <h2>‚úÖ X√°c Minh Ch·ªØ K√Ω</h2>
                <p>X√°c minh t√≠nh x√°c th·ª±c v√† to√†n v·∫πn c·ªßa file ƒë√£ k√Ω</p>

                <div class="form-group">
                    <label>üì¶ Ch·ªçn package ƒë√£ k√Ω (.json):</label>
                    <input type="file" id="signedPackage" accept=".json" onchange="loadSignedPackage()">
                </div>

                <div class="form-group">
                    <label>üîì Kh√≥a c√¥ng khai (Public Key):</label>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="publicKey" placeholder="Nh·∫≠p kh√≥a c√¥ng khai ƒë·ªÉ x√°c minh..."></textarea>
                        <button class="btn" onclick="copyPublicKey()" style="align-self: flex-start;">üìã Copy</button>
                    </div>
                </div>

                <button class="btn" onclick="verifySignature()">üîç X√°c Minh</button>
                <button class="btn btn-success" onclick="downloadVerifiedFile()" id="downloadVerifiedBtn" style="display:none;">üì• T·∫£i File G·ªëc</button>

                <div id="verifyResult"></div>
            </div>
        </div>

        <!-- Tab Chia S·∫ª -->
        <div id="share" class="tab-content">
            <div class="card">
                <h2>üì§ Chia S·∫ª File ƒê√£ K√Ω</h2>
                <p>G·ª≠i file ƒë√£ k√Ω v√† kh√≥a c√¥ng khai cho ng∆∞·ªùi kh√°c</p>

                <div class="form-group">
                    <label>üì¶ Package ƒë√£ k√Ω:</label>
                    <div id="signedPackagePreview" class="file-info" style="display: none;">
                        <h4>üìã Th√¥ng tin package</h4>
                        <p id="shareFileName"></p>
                        <p id="shareFileSize"></p>
                        <p id="shareTimestamp"></p>
                    </div>
                    <input type="file" id="sharePackageInput" accept=".json" onchange="previewSharePackage()">
                </div>

                <div class="form-group">
                    <label>üîì Kh√≥a c√¥ng khai:</label>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="sharePublicKey" placeholder="Kh√≥a c√¥ng khai s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn khi c√≥ package..."></textarea>
                        <button class="btn" onclick="copySharePublicKey()" style="align-self: flex-start;">üìã Copy</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>üìß Ph∆∞∆°ng th·ª©c chia s·∫ª:</label>
                    <select id="shareMethod" class="form-control">
                        <option value="email">Email</option>
                        <option value="link">T·∫°o li√™n k·∫øt</option>
                        <option value="manual">Sao ch√©p th·ªß c√¥ng</option>
                    </select>
                </div>

                <div id="emailShare" class="share-option">
                    <div class="form-group">
                        <label>ƒê·ªãa ch·ªâ email ng∆∞·ªùi nh·∫≠n:</label>
                        <input type="email" id="recipientEmail" class="form-control" placeholder="nhap@email.com">
                    </div>
                    <button class="btn btn-success" onclick="shareViaEmail()">üìß G·ª≠i qua Email</button>
                </div>

                <div id="linkShare" class="share-option" style="display: none;">
                    <div class="form-group">
                        <label>Li√™n k·∫øt chia s·∫ª:</label>
                        <input type="text" id="shareLink" class="form-control" readonly>
                    </div>
                    <button class="btn" onclick="copyShareLink()">üìã Sao ch√©p li√™n k·∫øt</button>
                </div>

                <div id="manualShare" class="share-option" style="display: none;">
                    <h4>üìã H∆∞·ªõng d·∫´n chia s·∫ª th·ªß c√¥ng</h4>
                    <ol style="margin-left: 20px; margin-bottom: 15px;">
                        <li>Sao ch√©p kh√≥a c√¥ng khai b√™n tr√™n</li>
                        <li>Sao ch√©p n·ªôi dung package ƒë√£ k√Ω</li>
                        <li>G·ª≠i c·∫£ hai cho ng∆∞·ªùi nh·∫≠n qua b·∫•t k·ª≥ ph∆∞∆°ng ti·ªán n√†o</li>
                    </ol>
                    <button class="btn" onclick="copyPackageForManualShare()">üìã Sao ch√©p to√†n b·ªô package</button>
                    <button class="btn" onclick="copySharePublicKey()" style="margin-left: 10px;">üìã Sao ch√©p kh√≥a c√¥ng khai</button>
                    <p class="help-text">G·ª≠i c·∫£ hai th√¥ng tin n√†y cho ng∆∞·ªùi nh·∫≠n ƒë·ªÉ h·ªç c√≥ th·ªÉ x√°c minh</p>
                </div>

                <div id="shareResult"></div>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let currentKeys = null;
        let signedData = null;
        let verifiedFileData = null;

        function copyPublicKey() {
            const publicKey = document.getElementById('publicKey').value;
            if (!publicKey) {
                showResult('verifyResult', '‚ùå Kh√¥ng c√≥ kh√≥a c√¥ng khai ƒë·ªÉ sao ch√©p', 'error');
                return;
            }
            navigator.clipboard.writeText(publicKey).then(() => {
                showResult('verifyResult', '‚úÖ ƒê√£ sao ch√©p kh√≥a c√¥ng khai v√†o clipboard!', 'success');
            });
        }

        function copySharePublicKey() {
            const publicKey = document.getElementById('sharePublicKey').value;
            if (!publicKey) {
                showResult('shareResult', '‚ùå Kh√¥ng c√≥ kh√≥a c√¥ng khai ƒë·ªÉ sao ch√©p', 'error');
                return;
            }
            navigator.clipboard.writeText(publicKey).then(() => {
                showResult('shareResult', '‚úÖ ƒê√£ sao ch√©p kh√≥a c√¥ng khai v√†o clipboard!', 'success');
            });
        }

        // Chuy·ªÉn ƒë·ªïi ArrayBuffer sang Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Chuy·ªÉn ƒë·ªïi Base64 sang ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // H√†m chuy·ªÉn ƒë·ªïi tab
        function showTab(tabName) {
            // ·∫®n t·∫•t c·∫£ tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // ·∫®n t·∫•t c·∫£ tab button active
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'share') {
                updateShareMethod();
            }
        }

        function updateShareMethod() {
            // ·∫®n t·∫•t c·∫£ c√°c ph∆∞∆°ng th·ª©c
            document.querySelectorAll('.share-option').forEach(el => el.style.display = 'none');
            
            // Hi·ªÉn th·ªã ph∆∞∆°ng th·ª©c ƒë∆∞·ª£c ch·ªçn
            const method = document.getElementById('shareMethod').value;
            document.getElementById(method + 'Share').style.display = 'block';
        }

        function previewSharePackage() {
            const fileInput = document.getElementById('sharePackageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const packageData = JSON.parse(e.target.result);
                    
                    document.getElementById('shareFileName').textContent = `File: ${packageData.originalFileName}`;
                    document.getElementById('shareFileSize').textContent = `K√≠ch th∆∞·ªõc: ${formatFileSize(packageData.fileData.length)}`;
                    document.getElementById('shareTimestamp').textContent = `Th·ªùi gian k√Ω: ${new Date(packageData.timestamp).toLocaleString('vi-VN')}`;
                    
                    document.getElementById('signedPackagePreview').style.display = 'block';
                    document.getElementById('sharePublicKey').value = JSON.stringify(packageData.publicKey, null, 2);
                    
                    // L∆∞u package ƒë·ªÉ chia s·∫ª
                    currentSharePackage = packageData;
                } catch (error) {
                    showResult('shareResult', `‚ùå File package kh√¥ng h·ª£p l·ªá: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function shareViaEmail() {
            const email = document.getElementById('recipientEmail').value.trim();
            
            if (!email) {
                showResult('shareResult', '‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email', 'error');
                return;
            }
            
            if (!currentSharePackage) {
                showResult('shareResult', '‚ùå Kh√¥ng c√≥ package ƒë·ªÉ chia s·∫ª', 'error');
                return;
            }
            
            try {
                const subject = `[File ƒë√£ k√Ω] ${currentSharePackage.originalFileName}`;
                const body = `Xin ch√†o,\n\nT√¥i g·ª≠i b·∫°n file ƒë√£ k√Ω s·ªë...`;
                
                // T·∫°o th·∫ª <a> ·∫©n
                const mailtoLink = document.createElement('a');
                mailtoLink.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                mailtoLink.style.display = 'none';
                
                // Th√™m s·ª± ki·ªán fallback
                mailtoLink.onclick = (e) => {
                    e.preventDefault();
                    window.location.href = mailtoLink.href;
                };
                
                document.body.appendChild(mailtoLink);
                mailtoLink.click();
                document.body.removeChild(mailtoLink);
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                showResult('shareResult', `
                    <div class="status-indicator status-success"></div>
                    <strong>üìß ƒêang m·ªü tr√¨nh g·ª≠i email...</strong>
                    <p>N·∫øu kh√¥ng th·∫•y tr√¨nh g·ª≠i email, vui l√≤ng:</p>
                    <button onclick="window.location.href='${mailtoLink.href}'" 
                            class="btn" 
                            style="margin-top: 10px;">
                        üöÄ Nh·∫•n ƒë·ªÉ m·ªü th·ªß c√¥ng
                    </button>
                `, 'success');
                
            } catch (error) {
                showResult('shareResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        function openEmailClient() {
            const email = document.getElementById('recipientEmail').value.trim();
            if (!email) return;
            
            const subject = "File ƒë√£ k√Ω RSA";
            const body = "N·ªôi dung email...";
            
            // C√°ch 1: D√πng th·∫ª <a> ·∫©n
            const mailtoLink = document.createElement('a');
            mailtoLink.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            mailtoLink.style.display = 'none';
            document.body.appendChild(mailtoLink);
            mailtoLink.click();
            document.body.removeChild(mailtoLink);
            
            // C√°ch 2: Fallback n·∫øu c√°ch 1 kh√¥ng ho·∫°t ƒë·ªông
            setTimeout(() => {
                try {
                    window.location.href = mailtoLink.href;
                } catch (e) {
                    alert("Kh√¥ng th·ªÉ m·ªü tr√¨nh g·ª≠i email. Vui l√≤ng ki·ªÉm tra ·ª©ng d·ª•ng email m·∫∑c ƒë·ªãnh.");
                }
            }, 100);
        }

        // Th√™m ki·ªÉm tra tr∆∞·ªõc khi m·ªü
        function isEmailClientAvailable() {
            return navigator.userAgent.match(/mailto:/i) || 
                navigator.userAgent.includes('Outlook') || 
                navigator.userAgent.includes('Thunderbird');
        }

        function setupEmailFallback(subject, body) {
            const fallbackDiv = document.getElementById('emailFallback');
            const emailBtn = document.getElementById('manualEmailBtn');
            const emailContent = document.getElementById('emailContent');
            
            emailContent.value = `Subject: ${subject}\n\n${body}`;
            emailBtn.onclick = () => {
                window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            };
            
            setTimeout(() => {
                fallbackDiv.style.display = 'block';
            }, 3000); // Hi·ªÉn th·ªã fallback sau 3 gi√¢y
        }

        async function generateRealShareLink() {
            if (!currentSharePackage) {
                showResult('shareResult', '‚ùå Kh√¥ng c√≥ package ƒë·ªÉ chia s·∫ª', 'error');
                return;
            }
            
            try {
                // Trong th·ª±c t·∫ø, b·∫°n c·∫ßn g·ª≠i d·ªØ li·ªáu l√™n server v√† nh·∫≠n l·∫°i m·ªôt link
                // ·ªû ƒë√¢y ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng localStorage ƒë·ªÉ m√¥ ph·ªèng
                
                // T·∫°o ID ng·∫´u nhi√™n
                const shareId = 'share_' + Math.random().toString(36).substring(2, 11);
                
                // L∆∞u v√†o localStorage
                localStorage.setItem(shareId, JSON.stringify(currentSharePackage));
                
                // T·∫°o link (gi·∫£ ƒë·ªãnh domain c·ªßa b·∫°n)
                const shareLink = `${window.location.origin}${window.location.pathname}?shareId=${shareId}`;
                
                document.getElementById('shareLink').value = shareLink;
                
                showResult('shareResult', `
                    <div class="status-indicator status-success"></div>
                    <strong>üîó Li√™n k·∫øt chia s·∫ª ƒë√£ s·∫µn s√†ng!</strong>
                    <p>Li√™n k·∫øt n√†y s·∫Ω ho·∫°t ƒë·ªông trong tr√¨nh duy·ªát hi·ªán t·∫°i cho ƒë·∫øn khi b·∫°n ƒë√≥ng tr√¨nh duy·ªát.</p>
                    <p>Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n c·∫ßn l∆∞u d·ªØ li·ªáu l√™n server ƒë·ªÉ c√≥ link chia s·∫ª l√¢u d√†i.</p>
                `, 'success');
            } catch (error) {
                showResult('shareResult', `‚ùå L·ªói t·∫°o li√™n k·∫øt: ${error.message}`, 'error');
            }
        }

        function copyShareLink() {
            if (!currentSharePackage) {
                showResult('shareResult', '‚ùå Kh√¥ng c√≥ package ƒë·ªÉ chia s·∫ª', 'error');
                return;
            }
            
            // Trong th·ª±c t·∫ø, b·∫°n c·∫ßn l∆∞u package l√™n server v√† t·∫°o link
            // ƒê√¢y ch·ªâ l√† minh h·ªça
            const fakeLink = `${window.location.href}?sharedPackage=${encodeURIComponent(JSON.stringify(currentSharePackage))}`;
            document.getElementById('shareLink').value = fakeLink;
            
            navigator.clipboard.writeText(fakeLink).then(() => {
                showResult('shareResult', '‚úÖ ƒê√£ sao ch√©p li√™n k·∫øt v√†o clipboard!', 'success');
            });
        }

        function copyPackageForManualShare() {
            if (!currentSharePackage) {
                showResult('shareResult', '‚ùå Kh√¥ng c√≥ package ƒë·ªÉ chia s·∫ª', 'error');
                return;
            }
            
            const packageStr = JSON.stringify({
                message: "D·ªØ li·ªáu file ƒë√£ k√Ω - G·ª≠i c√πng v·ªõi kh√≥a c√¥ng khai ƒë·ªÉ x√°c minh",
                fileName: currentSharePackage.originalFileName,
                timestamp: currentSharePackage.timestamp,
                publicKey: currentSharePackage.publicKey,
                signature: currentSharePackage.signature,
                fileData: currentSharePackage.fileData,
                instructions: `1. D√°n kh√≥a c√¥ng khai v√†o tab "X√°c Minh"
        2. T·∫£i package n√†y l√™n ƒë·ªÉ x√°c minh
        3. Nh·∫•n n√∫t "X√°c Minh" ƒë·ªÉ ki·ªÉm tra t√≠nh to√†n v·∫πn c·ªßa file`
            }, null, 2);
            
            navigator.clipboard.writeText(packageStr).then(() => {
                showResult('shareResult', `
                    <div class="status-indicator status-success"></div>
                    <strong>‚úÖ ƒê√£ sao ch√©p d·ªØ li·ªáu package v√†o clipboard!</strong>
                    <div class="file-info">
                        <h4>üìã H∆∞·ªõng d·∫´n g·ª≠i cho ng∆∞·ªùi nh·∫≠n</h4>
                        <p>1. G·ª≠i c·∫£ n·ªôi dung v·ª´a sao ch√©p</p>
                        <p>2. V√† kh√≥a c√¥ng khai (n·∫øu ch∆∞a c√≥ trong package)</p>
                        <p>3. H∆∞·ªõng d·∫´n ng∆∞·ªùi nh·∫≠n d√°n v√†o tab "X√°c Minh"</p>
                    </div>
                `, 'success');
            });
        }

        // Th√™m s·ª± ki·ªán khi thay ƒë·ªïi ph∆∞∆°ng th·ª©c chia s·∫ª
        document.getElementById('shareMethod').addEventListener('change', updateShareMethod);

        // Th√™m bi·∫øn to√†n c·ª•c
        let currentSharePackage = null;

        // H√†m t·∫°o s·ªë nguy√™n t·ªë ng·∫´u nhi√™n
        function generateRandomPrime(bits) {
            const min = Math.pow(2, bits - 1);
            const max = Math.pow(2, bits) - 1;
            
            let candidate;
            do {
                candidate = Math.floor(Math.random() * (max - min + 1)) + min;
                // ƒê·∫£m b·∫£o s·ªë l·∫ª
                if (candidate % 2 === 0) candidate++;
            } while (!isPrime(candidate));
            
            return candidate;
        }

        // Ki·ªÉm tra s·ªë nguy√™n t·ªë (Miller-Rabin test ƒë∆°n gi·∫£n)
        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            
            // Test v·ªõi m·ªôt v√†i s·ªë nh·ªè
            for (let i = 3; i <= Math.sqrt(n); i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        // Thu·∫≠t to√°n Euclidean m·ªü r·ªông
        function extendedGCD(a, b) {
            if (a === 0) return [b, 0, 1];
            const [gcd, x1, y1] = extendedGCD(b % a, a);
            const x = y1 - Math.floor(b / a) * x1;
            const y = x1;
            return [gcd, x, y];
        }

        // T√¨m ngh·ªãch ƒë·∫£o modular
        function modInverse(a, m) {
            const [gcd, x] = extendedGCD(a, m);
            if (gcd !== 1) throw new Error('Kh√¥ng t·ªìn t·∫°i ngh·ªãch ƒë·∫£o modular');
            return ((x % m) + m) % m;
        }

        // H√†m m≈© modular
        function modPow(base, exp, mod) {
            let result = 1;
            base = base % mod;
            while (exp > 0) {
                if (exp % 2 === 1) result = (result * base) % mod;
                exp = Math.floor(exp / 2);
                base = (base * base) % mod;
            }
            return result;
        }

        // Thay th·∫ø h√†m generateKeys b·∫±ng:
        async function generateKeys() {
            const keySize = parseInt(document.getElementById('keySize').value);
            
            try {
                const keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "RSASSA-PKCS1-v1_5",
                        modulusLength: keySize,
                        publicExponent: new Uint8Array([0x01, 0x00, 0x01]), // 65537
                        hash: {name: "SHA-256"},
                    },
                    true,
                    ["sign", "verify"]
                );
                
                const exportedPublicKey = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);
                const exportedPrivateKey = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
                
                currentKeys = {
                    publicKey: exportedPublicKey,
                    privateKey: exportedPrivateKey,
                    keySize: keySize
                };
                
                displayKeys();
            } catch (error) {
                showResult('keyResult', `‚ùå L·ªói t·∫°o kh√≥a: ${error.message}`, 'error');
            }
        }

        function showProgress(message, percent) {
            document.getElementById('keyResult').innerHTML = `
                <div class="result">
                    <div><strong>${message}</strong></div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">${percent}%</div>
                </div>
            `;
        }

        function displayKeys() {
            const publicKeyStr = JSON.stringify(currentKeys.publicKey, null, 2);
            const privateKeyStr = JSON.stringify(currentKeys.privateKey, null, 2);
            
            document.getElementById('keyResult').innerHTML = `
                <div class="result success">
                    <div class="status-indicator status-success"></div>
                    <strong>‚úÖ T·∫°o kh√≥a th√†nh c√¥ng!</strong>
                    <p>ƒê·ªô d√†i kh√≥a: ${currentKeys.keySize} bit</p>
                </div>
                
                <div class="grid">
                    <div>
                        <h4>üîì Kh√≥a C√¥ng Khai (Public Key)</h4>
                        <div class="key-display">${publicKeyStr}</div>
                        <button class="btn" onclick="copyToClipboard('${publicKeyStr.replace(/"/g, '&quot;')}')">üìã Sao ch√©p</button>
                    </div>
                    
                    <div>
                        <h4>üîê Kh√≥a Ri√™ng T∆∞ (Private Key)</h4>
                        <div class="key-display">${privateKeyStr}</div>
                        <button class="btn" onclick="copyToClipboard('${privateKeyStr.replace(/"/g, '&quot;')}')">üìã Sao ch√©p</button>
                    </div>
                </div>
                
                <div class="result" style="background: #fff3cd; border-left-color: #ffa502;">
                    <div class="status-indicator status-warning"></div>
                    <strong>‚ö†Ô∏è L∆∞u √Ω b·∫£o m·∫≠t:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Kh√≥a c√¥ng khai c√≥ th·ªÉ chia s·∫ª v·ªõi ng∆∞·ªùi kh√°c</li>
                        <li>Kh√≥a ri√™ng t∆∞ ph·∫£i ƒë∆∞·ª£c b·∫£o m·∫≠t tuy·ªát ƒë·ªëi</li>
                        <li>Kh√¥ng chia s·∫ª kh√≥a ri√™ng t∆∞ v·ªõi b·∫•t k·ª≥ ai</li>
                    </ul>
                </div>
            `;
            
            // T·ª± ƒë·ªông ƒëi·ªÅn kh√≥a ri√™ng t∆∞ v√†o tab k√Ω
            document.getElementById('privateKey').value = privateKeyStr;
            document.getElementById('publicKey').value = publicKeyStr;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ sao ch√©p v√†o clipboard!');
            }).catch(() => {
                alert('‚ùå Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng.');
            });
        }

        // X·ª≠ l√Ω ch·ªçn file
        function handleFileSelect(input, context) {
            const file = input.files[0];
            if (!file) return;
            
            const fileInfo = `
                <div class="file-info">
                    <h4>üìÅ Th√¥ng tin file</h4>
                    <p><strong>T√™n:</strong> ${file.name}</p>
                    <p><strong>K√≠ch th∆∞·ªõc:</strong> ${formatFileSize(file.size)}</p>
                    <p><strong>Lo·∫°i:</strong> ${file.type || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                    <p><strong>S·ª≠a ƒë·ªïi l·∫ßn cu·ªëi:</strong> ${new Date(file.lastModified).toLocaleString('vi-VN')}</p>
                </div>
            `;
            
            if (context === 'sign') {
                const resultDiv = document.getElementById('signResult');
                resultDiv.innerHTML = fileInfo;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // T·∫°o hash ƒë∆°n gi·∫£n cho file
        function simpleHash(data) {
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        async function signFile() {
            const fileInput = document.getElementById('fileToSign');
            const privateKeyStr = document.getElementById('privateKey').value.trim();
            
            if (!fileInput.files[0]) {
                showResult('signResult', '‚ùå Vui l√≤ng ch·ªçn file c·∫ßn k√Ω!', 'error');
                return;
            }
            
            if (!privateKeyStr) {
                showResult('signResult', '‚ùå Vui l√≤ng nh·∫≠p kh√≥a ri√™ng t∆∞!', 'error');
                return;
            }
            
            try {
                const privateKey = JSON.parse(privateKeyStr);
                const file = fileInput.files[0];
                
                // ƒê·ªçc file d∆∞·ªõi d·∫°ng ArrayBuffer
                const fileData = await readFileAsArrayBuffer(file);
                
                // T·∫°o hash SHA-256 c·ªßa file
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', fileData);
                
                // Import private key ƒë·ªÉ k√Ω
                const importedPrivateKey = await window.crypto.subtle.importKey(
                    "jwk",
                    privateKey,
                    {
                        name: "RSASSA-PKCS1-v1_5",
                        hash: {name: "SHA-256"},
                    },
                    false,
                    ["sign"]
                );
                
                // T·∫°o ch·ªØ k√Ω s·ªë
                const signature = await window.crypto.subtle.sign(
                    "RSASSA-PKCS1-v1_5",
                    importedPrivateKey,
                    hashBuffer
                );
                
                // T·∫°o package ƒë√£ k√Ω
                signedData = {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    fileData: arrayBufferToBase64(fileData),
                    signature: arrayBufferToBase64(signature),
                    timestamp: new Date().toISOString(),
                    hash: Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('')
                };
                
                showResult('signResult', `
                    <div class="status-indicator status-success"></div>
                    <strong>‚úÖ K√Ω file th√†nh c√¥ng!</strong>
                    <div class="file-info">
                        <h4>üìã Th√¥ng tin ch·ªØ k√Ω</h4>
                        <p><strong>File:</strong> ${file.name}</p>
                        <p><strong>Hash:</strong> ${signedData.hash}</p>
                        <p><strong>Th·ªùi gian:</strong> ${new Date().toLocaleString('vi-VN')}</p>
                    </div>
                `, 'success');
                
                document.getElementById('downloadBtn').style.display = 'inline-block';
                
            } catch (error) {
                showResult('signResult', `‚ùå L·ªói k√Ω file: ${error.message}`, 'error');
            }
        }

// H√†m ƒë·ªçc file d∆∞·ªõi d·∫°ng ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }     
                
            

        function downloadSignedPackage() {
            if (!signedData) return;
            
            const originalName = signedData.fileName;
            const dotIndex = originalName.lastIndexOf('.');
            const baseName = dotIndex !== -1 ? originalName.substring(0, dotIndex) : originalName;
            
            // Th√™m public key v√†o package
            const packageData = {
                originalFileName: signedData.fileName,
                signedFileName: `${baseName}.signed.json`,
                fileData: signedData.fileData,
                signature: signedData.signature,
                publicKey: currentKeys ? currentKeys.publicKey : null,
                timestamp: signedData.timestamp,
                hash: signedData.hash
            };
            
            const dataStr = JSON.stringify(packageData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${baseName}.signed.json`;
            link.click();
            
            // L∆∞u package ƒë·ªÉ chia s·∫ª
            currentSharePackage = packageData;
        }

        function loadSignedPackage() {
            const fileInput = document.getElementById('signedPackage');
            const file = fileInput.files[0];
            
            if (!file) {
                // Ki·ªÉm tra n·∫øu c√≥ shareId trong URL
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('shareId');
                
                if (shareId) {
                    try {
                        const packageData = JSON.parse(localStorage.getItem(shareId));
                        if (packageData) {
                            processPackageData(packageData);
                            return;
                        }
                    } catch (error) {
                        console.error('Error loading from shareId:', error);
                    }
                }
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const packageData = JSON.parse(e.target.result);
                    processPackageData(packageData);
                } catch (error) {
                    showResult('verifyResult', `‚ùå File package kh√¥ng h·ª£p l·ªá: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        function processPackageData(packageData) {
            // L∆∞u d·ªØ li·ªáu ƒë·ªÉ x√°c minh sau
            signedData = {
                fileName: packageData.originalFileName,
                fileSize: packageData.fileData.length,
                fileType: packageData.fileData.type,
                fileData: packageData.fileData,
                signature: packageData.signature,
                timestamp: packageData.timestamp
            };
            
            document.getElementById('verifyResult').innerHTML = `
                <div class="file-info">
                    <h4>üì¶ Th√¥ng tin package</h4>
                    <p><strong>File g·ªëc:</strong> ${packageData.originalFileName}</p>
                    <p><strong>K√≠ch th∆∞·ªõc:</strong> ${formatFileSize(packageData.fileData.length)}</p>
                    <p><strong>Th·ªùi gian k√Ω:</strong> ${new Date(packageData.timestamp).toLocaleString('vi-VN')}</p>
                    <p><strong>Ch·ªØ k√Ω:</strong> ${packageData.signature.substring(0, 50)}...</p>
                </div>
            `;
            
            // T·ª± ƒë·ªông ƒëi·ªÅn public key n·∫øu c√≥
            if (packageData.publicKey) {
                document.getElementById('publicKey').value = JSON.stringify(packageData.publicKey, null, 2);
            }
        }

        async function verifySignature() {
            const publicKeyStr = document.getElementById('publicKey').value.trim();
            
            if (!signedData) {
                showResult('verifyResult', '‚ùå Vui l√≤ng t·∫£i package ƒë√£ k√Ω!', 'error');
                return;
            }
            
            if (!publicKeyStr) {
                showResult('verifyResult', '‚ùå Vui l√≤ng nh·∫≠p kh√≥a c√¥ng khai!', 'error');
                return;
            }
            
            try {
                const publicKey = JSON.parse(publicKeyStr);
                const fileData = base64ToArrayBuffer(signedData.fileData);
                const signature = base64ToArrayBuffer(signedData.signature);
                
                // T·∫°o hash SHA-256 c·ªßa file
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', fileData);
                const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Import public key ƒë·ªÉ x√°c minh
                const importedPublicKey = await window.crypto.subtle.importKey(
                    "jwk",
                    publicKey,
                    {
                        name: "RSASSA-PKCS1-v1_5",
                        hash: {name: "SHA-256"},
                    },
                    false,
                    ["verify"]
                );
                
                // X√°c minh ch·ªØ k√Ω
                const isValid = await window.crypto.subtle.verify(
                    "RSASSA-PKCS1-v1_5",
                    importedPublicKey,
                    signature,
                    hashBuffer
                );
                
                if (isValid) {
                    verifiedFileData = {
                        name: signedData.fileName,
                        data: fileData,
                        type: signedData.fileType
                    };
                    
                    showResult('verifyResult', `
                        <div class="status-indicator status-success"></div>
                        <strong>‚úÖ X√°c minh th√†nh c√¥ng!</strong>
                        <div class="file-info">
                            <h4>‚úÖ K·∫øt qu·∫£ x√°c minh</h4>
                            <p><strong>Tr·∫°ng th√°i:</strong> <span style="color: #2ed573;">H·ª£p l·ªá</span></p>
                            <p><strong>File:</strong> ${signedData.fileName}</p>
                            <p><strong>Hash:</strong> ${hashHex}</p>
                            <p><strong>Th·ªùi gian k√Ω:</strong> ${new Date(signedData.timestamp).toLocaleString('vi-VN')}</p>
                        </div>
                        <p style="color: #2ed573; font-weight: 600;">üîí File n√†y ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† kh√¥ng b·ªã thay ƒë·ªïi!</p>
                    `, 'success');
                    
                    document.getElementById('downloadVerifiedBtn').style.display = 'inline-block';
                } else {
                    showResult('verifyResult', `
                        <div class="status-indicator status-error"></div>
                        <strong>‚ùå X√°c minh th·∫•t b·∫°i!</strong>
                        <div class="file-info">
                            <h4>‚ùå K·∫øt qu·∫£ x√°c minh</h4>
                            <p><strong>Tr·∫°ng th√°i:</strong> <span style="color: #ff6b6b;">Kh√¥ng h·ª£p l·ªá</span></p>
                            <p><strong>File:</strong> ${signedData.fileName}</p>
                            <p><strong>Hash:</strong> ${hashHex}</p>
                        </div>
                        <p style="color: #ff6b6b; font-weight: 600;">‚ö†Ô∏è File n√†y c√≥ th·ªÉ ƒë√£ b·ªã thay ƒë·ªïi ho·∫∑c ch·ªØ k√Ω kh√¥ng ch√≠nh x√°c!</p>
                    `, 'error');
                }
            } catch (error) {
                showResult('verifyResult', `‚ùå L·ªói x√°c minh: ${error.message}`, 'error');
            }
        }

        // T·∫£i file ƒë√£ x√°c minh
        function downloadVerifiedFile() {
            if (!verifiedFileData) return;
            
            const dataBlob = new Blob([verifiedFileData.data], {type: verifiedFileData.type});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = verifiedFileData.name;
            link.click();
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        function showResult(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            // T·ª± ƒë·ªông t·∫°o kh√≥a demo khi load trang
            setTimeout(() => {
                if (!currentKeys) {
                    generateKeys();
                }
            }, 1000);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const sharedPackage = urlParams.get('sharedPackage');
        
        if (sharedPackage) {
            try {
                const packageData = JSON.parse(decodeURIComponent(sharedPackage));
                
                // T·ª± ƒë·ªông chuy·ªÉn ƒë·∫øn tab verify v√† ƒëi·ªÅn th√¥ng tin
                showTab('verify');
                
                // Gi·∫£ l·∫≠p vi·ªác t·∫£i package
                signedData = {
                    fileName: packageData.originalFileName,
                    fileData: packageData.fileData,
                    signature: packageData.signature,
                    timestamp: packageData.timestamp
                };
                
                document.getElementById('publicKey').value = JSON.stringify(packageData.publicKey, null, 2);
                
                document.getElementById('verifyResult').innerHTML = `
                    <div class="file-info">
                        <h4>üì¶ Package nh·∫≠n ƒë∆∞·ª£c qua li√™n k·∫øt</h4>
                        <p><strong>File g·ªëc:</strong> ${packageData.originalFileName}</p>
                        <p><strong>Th·ªùi gian k√Ω:</strong> ${new Date(packageData.timestamp).toLocaleString('vi-VN')}</p>
                    </div>
                    <p>B·∫°n c√≥ th·ªÉ x√°c minh ngay b√¢y gi·ªù.</p>
                `;
            } catch (e) {
                console.error('L·ªói ph√¢n t√≠ch package t·ª´ URL:', e);
            }
        }

        // Th√™m hi·ªáu ·ª©ng hover cho c√°c n√∫t
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('btn')) {
                e.target.style.transform = 'translateY(-2px)';
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('btn')) {
                e.target.style.transform = 'translateY(0)';
            }
        });

        // X·ª≠ l√Ω drag & drop cho file input
        function setupDragDrop(inputId) {
            const input = document.getElementById(inputId);
            const parent = input.parentElement;
            
            parent.addEventListener('dragover', function(e) {
                e.preventDefault();
                parent.style.backgroundColor = '#f0f8ff';
                parent.style.border = '2px dashed #667eea';
            });
            
            parent.addEventListener('dragleave', function(e) {
                e.preventDefault();
                parent.style.backgroundColor = '';
                parent.style.border = '';
            });
            
            parent.addEventListener('drop', function(e) {
                e.preventDefault();
                parent.style.backgroundColor = '';
                parent.style.border = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }

        // Thi·∫øt l·∫≠p drag & drop khi trang load
        window.addEventListener('load', function() {
            setupDragDrop('fileToSign');
            setupDragDrop('signedPackage');
        });

        // Th√™m validation cho kh√≥a
        function validateKey(keyStr, type) {
            try {
                const key = JSON.parse(keyStr);
                
                if (type === 'private') {
                    if (!key.n || !key.d) {
                        throw new Error('Kh√≥a ri√™ng t∆∞ kh√¥ng h·ª£p l·ªá - thi·∫øu n ho·∫∑c d');
                    }
                } else if (type === 'public') {
                    if (!key.n || !key.e) {
                        throw new Error('Kh√≥a c√¥ng khai kh√¥ng h·ª£p l·ªá - thi·∫øu n ho·∫∑c e');
                    }
                }
                
                return true;
            } catch (error) {
                return false;
            }
        }

        // Th√™m real-time validation cho textarea
        document.getElementById('privateKey').addEventListener('input', function() {
            const isValid = validateKey(this.value, 'private');
            this.style.borderColor = isValid ? '#2ed573' : '#ff6b6b';
        });

        document.getElementById('publicKey').addEventListener('input', function() {
            const isValid = validateKey(this.value, 'public');
            this.style.borderColor = isValid ? '#2ed573' : '#ff6b6b';
        });

        // Th√™m shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        showTab('generate');
                        break;
                    case '2':
                        e.preventDefault();
                        showTab('sign');
                        break;
                    case '3':
                        e.preventDefault();
                        showTab('verify');
                        break;
                }
            }
        });

        // Th√™m tooltip cho shortcuts
        const style = document.createElement('style');
        style.textContent = `
            .tab-button::after {
                content: '';
                position: absolute;
                bottom: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 12px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                white-space: nowrap;
            }
            
            .tab-button:nth-child(1)::after { content: 'Ctrl+1'; }
            .tab-button:nth-child(2)::after { content: 'Ctrl+2'; }
            .tab-button:nth-child(3)::after { content: 'Ctrl+3'; }
            
            .tab-button:hover::after {
                opacity: 1;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>